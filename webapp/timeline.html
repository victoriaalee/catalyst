<!doctype html>
<html lang="en" class="no-js">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href='http://fonts.googleapis.com/css?family=Droid+Serif|Open+Sans:400,700' rel='stylesheet' type='text/css'>

	<link rel="stylesheet" href="vertical-timeline/css/reset.css"> <!-- CSS reset -->
	<link rel="stylesheet" href="vertical-timeline/css/style.css"> <!-- Resource style -->
	<script src="vertical-timeline/js/modernizr.js"></script> <!-- Modernizr -->
	
	<title>Patient Timeline</title>
</head>

<body>
	<header>
		<h1 id="headline">Loading...</h1>
	</header>
	
	<section>
		<ul class="nav">
			<li class="nav"><a href="#timeline">Timeline</a></li>
			<li class="nav"><a href="#background">Background</a></li>
			<li class="nav"><a href="#data">Data</a></li>
		</ul class="nav">
	<a name="timeline"/>

	
	</section>
<a name="background"/>
	<div class="fillerbox"></div>
	<div class="section_header" id="one">Background</div>
	<div class="myBox">
	<
	<div class="background_text">
	<h3>Past Events:</h3>
	<ul>
		<li>Hit head on concrete floor</li> 
		<li>Small pool of blood leaking</li> 
		<li>Had emergency craniotomy, pressure relieved</li>
		<li>Could not speak or swallow</li>
		<li>Transferred to rehab to walk unassisted</li>
		<li>Restore speech, and swallow sufficiently.</li>
	</ul>
	</div><div class="background_text" id="two">
	<h3>Current Situation:
</h3>
	<ul>
		<li>Three months since incident</li>
		<li>speech improved</li>
		<li>almost regular diet</li>
		<li>exercise plan to eliminate cane usage</li> 
		<li>swallowing</li>
	</ul>
	</div>
</div>
	<a name="timeline"/>
	<div class="fillerbox"></div>
	<div class="section_header">Timeline</div>
	
	<div class="myBox">
	<div class="input_box">
		<p class="data_input">Keyword:</p>
		<input class="data_input" type="text" name="keyword" id="input1">
		<button class="data_input" onclick="timelineInput()">Submit</button>
		<script type="text/javascript">
 function timelineInput(){
    var text=document.getElementById('input1').value;
 }
</script>
</div>
	<section id="cd-timeline" class="cd-container">

		
	</section> 
	</div>
	

	<a name="data"/>
	<div class="fillerbox"></div>
	<div class="section_header">Patient Data</div>
	<div class="myBox">
	<div class="input_box">
		<p class="data_input">Keyword:</p>
	<input class="data_input" type="text" name="keyword" id="input2">
	<button class="data_input" onclick="dataInput()">Submit</button>
	
	<div class="tabs">
    
   <div class="tab">
       <input type="radio" id="tab-1" name="tab-group-1" checked>
       <label for="tab-1">Allergies</label>
       
       <div id="tab1-content" class="content">
       </div> 
   </div>
    
   <div class="tab">
       <input type="radio" id="tab-2" name="tab-group-1">
       <label for="tab-2">Chronic Illnesses</label>
       
       <div id="tab2-content" class="content">
       </div> 
   </div>
    
    <div class="tab">
       <input type="radio" id="tab-3" name="tab-group-1">
       <label for="tab-3">Family History</label>
     
       <div id="tab3-content" class="content">
       </div> 
   </div>

   <div class="tab">
       <input type="radio" id="tab-4" name="tab-group-1" checked>
       <label for="tab-4">Imaging</label>
       
       <div id="tab4-content" class="content">
       </div> 
   </div>

   <div class="tab">
       <input type="radio" id="tab-5" name="tab-group-1" checked>
       <label for="tab-5">Lifestyle</label>
       
       <div id="tab5-content" class="content">
       </div> 
   </div>

   <div class="tab">
       <input type="radio" id="tab-6" name="tab-group-1" checked>
       <label for="tab-6">Vitals</label>
       
       <div id="tab6-content" class="content">
       </div> 
   </div>
    
</div>
	</div>
</div>
	<!-- cd-timeline -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="vertical-timeline/js/main.js"></script> <!-- Resource jQuery -->
<script src="js/util.js"></script>
<script src="js/fhir.js"></script>
<script src="vertical-timeline/js/timeline.js"></script>
<script>
	var timeline = document.getElementById("cd-timeline");
	var data = document.getElementById("data");
	var url = "http://fhir2.healthintersections.com.au/open";
	var patientIDNum = "ad2f3d7c-4274-4422-a10a-8e2bc99c40";

	setPatient(patientIDNum);
	/////
	function setPatient(patientID)
	{
		changeHeader("Loading Patient "+patientID+"...");

		var patient = searchPatientID(url, patientID);
		var patientName = patient.name[0].given[0] + " " + patient.name[0].family[0];
		changeHeader(patientName);

		var obs = searchResourcePatient(url, "Observation", patient);
		var enc = searchResourcePatient(url, "Encounter", patient);
		var aly= searchResourcePatient(url, "AllergyIntolerance", patient);
		var con = searchResourcePatient(url, "Condition", patient);

		var events = con.concat(aly.concat((enc.concat(obs))));
		var eventsContent = [];
		//Handle placement
		var timelineEvents = [];
		var timelineContent = [];
		var dataEvents = [];
		var dataContent = [];
		for(i = 0; i < events.length; i++)
		{
			var content = generateContent(events[i]);
			eventsContent.push(content);
			if(fromTime(content) != null)
			{
				timelineEvents.push(events[i]);
				timelineContent.push(content);
			}
			else
			{
				dataEvents.push(events[i]);
				dataContent.push(content);
			}
		}
		setTimeline(timelineEvents);
		setData(dataEvents);

		//setChildren(filterContent(events,eventsContent,"allergy"),document.getElementById("tab1-content"));
	}
	

	//////
	function removeChildren(dom)
	{
		while(dom.firstChild)
		{
			dom.removeChild(dom.firstChild);
		}
	}

	function setChildren(jsonObjects,container)
	{
		removeChildren(container);
		for(var i = 0; i < jsonObjects.length; i++)
		{
			container.appendChild(blockGenJSON(jsonObjects[i]));
		}
	}

	function setTimeline(jsonObjects)
	{
		removeChildren(timeline);
		for(var i = 0; i < jsonObjects.length; i++)
		{
			timeline.appendChild(blockGenJSON(jsonObjects[i]));
		}
	}

	function setData(jsonObjects)
	{
		removeChildren(data);
		for(var i = 0; i < jsonObjects.length; i++)
		{
			data.appendChild(blockGenJSON(jsonObjects[i]));
		}
	}

	function changeHeader(newTitle)
	{
		document.getElementById("headline").innerHTML = newTitle;
	}

	//Generates a block based on the content strings
	function blockGenJSON(jsonData)
	{
		if(jsonData == null)
			return null;
		return blockGen(generateContent(jsonData));
	}
	function blockGen(contentStr)
	{
		var titleArray = contentStr.match("<e>(.+?)<\/e>");
		var contentArray = contentStr.match("<n>(.+?)<\/n>");
		var dateArray = contentStr.match("<t>(.+?)<\/t>");
		var title = titleArray!=null?titleArray[0]:"";
		var content = contentArray!=null?contentArray[0]:"";
		var date = dateArray!=null?dateArray[0]:"";
		return generateBlock(title,content,date);
	}

	//
	function timelineInput(){
    	var filter = document.getElementById('input1').value;
    	var timeFiltered = filterContent(timelineEvents,timelineContent,filter);
    	setTimeline(timeFiltered);
 	}
 	function dataInput(){
    	var filter = document.getElementById('input2').value;
    	var dataFiltered = filterContent(dataEvents,dataContent,filter);
    	setData(dataFiltered);
 	}
</script>
</body>
</html>